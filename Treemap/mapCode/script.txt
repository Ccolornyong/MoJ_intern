<script>
	let mainComponentId = null;
	widget._selectedCategory = null;

	widget.componentReadyHandler = function(componentId){
		mainComponentId = componentId;

		if(!widget.isBindingSource()){
			document.getElementById(componentId).setDataType("json");
			document.getElementById(componentId).setDataURL(BIX5.getAssetsPath() + "Datasources/TreeMap-TreeMap_Dynamic.json");
		}
	};

	function formatToOnlyManUnit(value) {
		return (value / 10000).toFixed(2).replace(/\.?0+$/, '') + 'ë§Œ ëª…';
	}

	const labelCache = {};

	window.labelJsFunc202505_15 = function labelJsFunc(seriesId, index, data, values) {
		const key = data.sido + '_' + data.category;
		if (labelCache[key]) return labelCache[key];

		const category = values[1];
		const count = values[0];
		const countlocale = Number(values[0]).toLocaleString();
		const category_kor = data.category_kor;
		const rate = Number(data.rate_202505);
		const rateText = (rate >= 0 ? '+' : '') + rate.toFixed(1) + '%';
		const ratelabel = isNaN(rate) ? '-' : rateText;

		let fontSize = 10;
		let catSize = 10;

		const countInt = Number(count);
		const countText = formatToOnlyManUnit(countInt);

		if (countInt > 2000) {
			fontSize = 40; catSize = 35;
		} else if (countInt > 1000) {
			fontSize = 35; catSize = 30;
		} else if (countInt > 800) {
			fontSize = 30; catSize = 25;
		} else if (countInt > 500) {
			fontSize = 25; catSize = 20;
		} else if (countInt > 300) {
			fontSize = 20; catSize = 15;
		} else if (countInt > 100) {
			fontSize = 15; catSize = 13;
		} 

		const html = 
					'<font size="' + catSize + '">' + '(' + category + ')' +'</font>\n' +
					'<font size="' + fontSize + '"><b>' + category_kor + '</b></font>\n<br>' +
					'<font size="' + catSize + '"><b>' + countText + '</b></font>';

		labelCache[key] = html;
		return html;
	};


	// ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
	const groupLabelCache = {};

	widget.groupLabelJsFunction = function groupLabelJsFunc2025(seriesId, index, data, value) {

		if (groupLabelCache[seriesId]) return groupLabelCache[seriesId];

		const groupKey = seriesId;
		const groupInfo = window.groupDataMap[groupKey]?.total || 0;

		// ğŸ”¢ ì†Œìˆ˜ì  í•œ ìë¦¬ê¹Œì§€ ë§Œ ë‹¨ìœ„ë¡œ ê³„ì‚°
		const groupText = (groupInfo / 10000).toFixed(1) + 'ë§Œ ëª…';
		const label = groupKey+" ("+groupText+")";

		groupLabelCache[seriesId] = label;
		console.log("groupInfo:", label);

		return label;
	};

	window.fillByCategory02 = function(seriesId, index, data, values) {
		if (widget._selectedCategory && data.category === widget._selectedCategory) {
			return "#59c9c4"; // ê°•ì¡° ìƒ‰ìƒ
		}

		const rate = Number(data["rate_202505"]);
		if (isNaN(rate)) return '#cccccc';

		// const clamped = Math.max(-10, Math.min(10, rate));
		// const t = (clamped+10)/20;

		// return interpolateColor("#a83232", "#3c5a50", "#2a7f2e", t);

		if (rate < -10) {
			return "#F63538";  // ë§¤ìš° í° ê°ì†Œ
		} else if (rate < -5) {
			return "#D73C3F";  // í° ê°ì†Œ
		} else if (rate < -3) {
			return "#C73E43";  // ì¤‘ê°„ ê°ì†Œ
		} else if (rate < -1) {
			return "#AE4248";  // ì•½ê°„ ê°ì†Œ
		} else if (rate < 0) {
			return "#57333b";  // ì¬ë” ê°ì†Œ
		} else if (rate === 0) {
			return "#414554";  // ë³€í™” ì—†ìŒ
		} else if (rate <= 0) {
			return "#3D5451";  // ì¬ê¸ˆ ì¦ê°€
		} else if (rate <= 1) {
			return "#38694F";  // ì•½ê°„ ì¦ê°€
		} else if (rate <= 3) {
			return "#31894E";  // ì¤‘ê°„ ì¦ê°€
		} else if (rate <= 5) {
			return "#30974F";  // í° ì¦ê°€
		} else { // rate > 5
			return "#30CC5A";  // ë§¤ìš° í° ì¦ê°€
		}

	};

	window.myDataTip2021 = function dataTipJsFunction(seriesId, seriesName, index, xName, yName, data, values) {
		const sido = data.sido;
		const category_kor = data.category_kor || "ì¹´í…Œê³ ë¦¬ ì—†ìŒ";
		const count = data.count_202505;
		const countText = isNaN(count) ? "-" : `${count}`;
		const rate = Number(data.rate_202505);
		const rateText = (rate >= 0 ? '+' : '') + rate.toFixed(1) + '%';

		return `${category_kor}<br>ì¸ì›ìˆ˜: ${countText}<br>ì¦ê°ë¥ : ${rateText}`;
	};

	window.borderByCategory2021 = function(seriesId, index, data, values) {
		// const rate = data["rate_2021"];
		// if (rate >= 20 || rate <= -20) {
		// 	return { color: "#ffffff", weight: 3 };
		// } else {
		return { color: "#000000", weight: 1 };
		// }
	};

	window.itemClickJsFunc2025 = function itemClickJsFunction(seriesId, displayText, index, data, values) {
		const clickedCategory = data.category;

		if (widget._selectedCategory === clickedCategory) {
			widget._selectedCategory = null;
		} else {
			widget._selectedCategory = clickedCategory;
		}

		console.log("ğŸ–±ï¸ ì„ íƒëœ category:", window._selectedCategory);

		// âœ… ì„ íƒ í›„ ê°•ì œë¡œ ë‹¤ì‹œ ê·¸ë¦¼
		// const comp = widget.getComponent();
		// if (comp && typeof comp.redraw === "function") {
		// 	comp.redraw();
		// }
	};

	widget.setTransformSourceHandler(function(topic, payload) {

		// âœ… ì„œìš¸íŠ¹ë³„ì‹œë§Œ í•„í„°ë§
		payload = payload.filter(row => row["ì‹œë„ëª…"] === "ì œì£¼íŠ¹ë³„ìì¹˜ë„");

		window.groupDataMap = {};

		const map = {};
		const rates = [];

		payload.forEach(row => {
			const sido = row["ì‹œêµ°êµ¬ëª…"];
			const category = row["ìê²©_ëŒ€ë¶„ë¥˜"];
			const category_kor = row["ìê²©_ì½”ë“œëª…"];
			const count_202504 = Number(row["202504_ì™¸êµ­ì¸ìˆ˜"]);
			const count_202505 = Number(row["202505_ì™¸êµ­ì¸ìˆ˜"]);
			const rate_202505 = Number(row["2504to2505"]);

			if (!map[sido]) map[sido] = [];

			map[sido].push({
				sido,
				category,
				category_kor,
				count_202504,
				count_202505,
				rate_202505
			});

			// ê·¸ë£¹ í—¤ë”ìš©
			if (!window.groupDataMap[sido]) {
				window.groupDataMap[sido] = {total:0};
			}
			window.groupDataMap[sido].total += count_202505;

			rates.push(rate_202505);  // âœ… ëˆ„ë½ëœ ì´ ë¶€ë¶„ ì¶”ê°€!
		});

		window.minRate = Math.min(...rates);
		window.maxRate = Math.max(...rates);

		return Object.keys(map).map(sido => ({
			name: sido,
			items: map[sido]
		}));

	});

	widget.componentRemoveHandler = function() {};
</script>
