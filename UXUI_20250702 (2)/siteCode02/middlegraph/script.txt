<script>

	/**
	* componentë¥¼ ì‚¬ìš©í•  ì¤€ë¹„ê°€ ë˜ë©´ í˜¸ì¶œí•©ë‹ˆë‹¤
	*/
	widget.componentReadyHandler = function(componentId){

	}



	/**
	* ë°ì´í„° ë³€í˜• ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
	* ì½œë°±í•¨ìˆ˜ì— ì¸ìë¡œ topic, payloadê°€ ì „ë‹¬ë©ë‹ˆë‹¤.
	* payload: ìˆ˜ì‹ ëœ ë°ì´í„°. í•´ë‹¹ ê°’ì€ ì°¸ì¡°ëœ ê°’ì´ê¸° ë•Œë¬¸ì— ìœ ì˜í•˜ì—¬ ì‚¬ìš© ë°”ëë‹ˆë‹¤.
	*/
	/**
	widget.setTransformSourceHandler(function(topic, payload){
		return payload;
	});
	*/

	// ì§€ì—­ êµ¬ë¶„ì´ ê°™ì€ êµ­ê°€ í•©ì‚°í•˜ì—¬ ë²”ë¡€ë¡œ ì‚¬ìš©
	widget.setTransformSourceHandler(function(topic, payload) {
		const groupBy = 'code';
		const valueField = 'CNT';

		const result = [];
		const groupMap = {};

		// 1. ëŒ€ë¥™ë³„ CNT í•©ì‚°
		payload.forEach(item => {
			const key = item[groupBy]; // code = ëŒ€ë¥™ ì½”ë“œ
			if (!groupMap[key]) {
				groupMap[key] = {
					code: key,        // ìµœì¢… ê²°ê³¼ì— ë“¤ì–´ê°ˆ code
					CNT: 0            // ëˆ„ì ìš© CNT ì´ˆê¸°í™”
				};
			}
			groupMap[key][valueField] += item[valueField];
		});

		for (const key in groupMap) {
			result.push(groupMap[key]);
			console.log("payload in Transform key: ", key);
		}

		const cntList = result.map(r => r[valueField]);
		const max = Math.max(...cntList);
		const min = Math.min(...cntList);
		const interval = Math.round((max-min)/5) || 1;

		console.log(cntList);

		window.gfn.addLayoutMetaData(widget, {
			minimum: min,
			maximum: max,
			interval: interval
		});

		console.log(min, max);

		console.log("payload in Transform result: ", result);

		return result;

	});

	/**
	* componentê°€ ì‚­ì œë˜ê¸° ì „ í˜¸ì¶œë©ë‹ˆë‹¤.
	*/
	widget.componentRemoveHandler = function(){

	}

	widget.dataTipJsFunc = function(seriesId, code, label, data) {
		const cnt = Number(data.CNT).toLocaleString(); // ì½¤ë§ˆ í¬í•¨ ìˆ«ì ì²˜ë¦¬

		return "ì´ë¯¼ì<br>"+cnt+" ì²œ ëª…"
	}

	console.log("hi1")

	widget.mapChangeJsFunc = function(code, label, data){
		console.log("ğŸ“¤ ì™¼ìª½ mapChangeJsFunc í˜¸ì¶œë¨", { code, label, data });

		const event = new CustomEvent("continentClick", {
			detail: {
				seriesId: Number(code),
				continentLabel: label
			}
		});

		console.log("ğŸ“¤ ì´ë²¤íŠ¸ detail í™•ì¸ (CustomEvent):", event.detail);

		widget.getSlide().dispatchEvent(event);
	};
	console.log("hi3")

	// dropdown to map widget
	widget.getSlide().addEventListener("continentClick", function(evt) {
		const detail = evt.detail || {};
		const seriesId = detail.seriesId;
		const continentLabel = detail.continentLabel;


		console.log("âœ… Dropdown to mapWidget:", seriesId, continentLabel);

		// 1) ì§€ë„ DrillDown
		// if (seriesId) {
		widget.getComponent().setSelectedCode(seriesId.toString());
		// }

	});

</script>