
<script>
	widget.componentReadyHandler = function(componentId) {
		console.log("âœ… ì˜¤ë¥¸ìª½ êµ­ê°€ë§µ ìœ„ì ¯ ì¤€ë¹„ë¨");
	};

	let originPayload = []; // ì›ë³¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜

	// 1. ì´ˆê¸° ë°ì´í„° ë°›ê¸° (í•œ ë²ˆë§Œ í˜¸ì¶œë¨)
	widget.setTransformSourceHandler(function(topic, payload) {
		console.log("âœ… ë°ì´í„° ë“¤ì–´ì˜´", payload);
		originPayload = payload;

		setTimeout(() => {
			widget.getComponent().setSelectedCode("603");
		}, 100); 

		return payload;
	});


	widget.getSlide().addEventListener("continentClick", function(evt) {
		const detail = evt.detail || {};
		const seriesId = detail.seriesId;
		const continentLabel = detail.continentLabel;
		console.log("âœ… ì˜¤ë¥¸ìª½ ìœ„ì ¯ continentClick ì´ë²¤íŠ¸ ìˆ˜ì‹ :", seriesId, continentLabel);

		// 1) ì§€ë„ DrillDown
		if (seriesId) {
			widget.getComponent().setOpenCode(seriesId.toString());
		}
		// 2) ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì„¤ì •
		window.gfn.setParams({
			seriesId: seriesId,
			continentLabel: continentLabel,
			id: widget.id
		});


		// 3) ìƒë‹¨ì— ë’¤ë¡œê°€ê¸° ì•ˆìƒê¸°ë„ë¡ rootcode ë°”ê¾¸ê¸°
		widget.getComponent().setRootCode(seriesId.toString());

		// 4) í•´ë‹¹ ì½”ë“œ ì§€ì—­ì— ë¹—ê¸ˆ
		const matches = originPayload.filter(item => item.ëŒ€ë¥™ === continentLabel);


		if (continentLabel === "ì•„ì‹œì•„") {
			selected = matches.find(item => item.NAT_HAN_NM === "ëŒ€í•œë¯¼êµ­" || item.code === 410);
		} else {
			selected = matches[0];
		}
		const countryId = selected.code;
		console.log("countryId: ", countryId);
		setTimeout(() => {
			widget.getComponent().setSelectedCode(countryId.toString());
		}, 100); 


		window.gfn.setSearchEvent(widget);

	});


	widget.getSlide().addEventListener("countryClick", function(evt) {
		const detail = evt.detail || {};
		const seriesId = detail.seriesId;
		const continentLabel = detail.continentLabel;
		const areaCd = detail.areaCd;
		console.log("âœ… ì˜¤ë¥¸ìª½ ìœ„ì ¯ countryClick ì´ë²¤íŠ¸ ìˆ˜ì‹ :", seriesId, continentLabel,areaCd);

		// 1) ì§€ë„ DrillDown
		// if (seriesId) {
		widget.getComponent().setSelectedCode(seriesId.toString());
		// }

		window.gfn.setSearchEvent(widget);

	});


	// ë°ì´í„° íŒ íˆ´
	widget.dataTipJsFunc = function(seriesId, code, label, data) {
		const cnt = Number(data.CNT).toLocaleString(); // ì½¤ë§ˆ í¬í•¨ ìˆ«ì ì²˜ë¦¬

		return label+" ì´ë¯¼ì<br>"+cnt+" ì²œ ëª…"
	}

	// ì„ íƒ ì‹œ
	widget.mapChangeJsFunc = function(code, label, data){
		// const matched = originPayload.find(item => String(item.country_code) === String(code));
		// const continent = matched?.ëŒ€ë¥™ || "ì•Œ ìˆ˜ ì—†ìŒ";
		console.log("ğŸ“¤ right map Click", { code, label, data});

		const continent = data?.ëŒ€ë¥™ || data?.continent || "ì •ë³´ ì—†ìŒ";
		let immirate = '-';
		if (data?.CNT !== undefined && data?.POP_CT_1000_UNIT_CNT) {
			const rate = data.CNT / data.POP_CT_1000_UNIT_CNT;
			if (isFinite(rate)) {
				immirate = (rate * 100).toFixed(2);
			}
		}


		const event = new CustomEvent("countryClick", {
			detail: {
				seriesId: Number(code),
				countryLabel: label,
				continentLabel: continent,
				constpopulation: data?.POP_CT_1000_UNIT_CNT,
				constRank: data?.POP_RANK,
				immicnt: data?.CNT,
				immirank: data?.IMM_RANK,
				immirate: immirate,
				areaCd: data?.AREA_CD
			}
		});

		console.log("ğŸ“¤ right map ì´ë²¤íŠ¸ detail í™•ì¸ (CustomEvent):", event.detail);

		widget.getSlide().dispatchEvent(event);
	};


</script>
